package fr.ign.validator.geometry;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertThrows;
import static org.junit.Assert.assertTrue;

import org.geotools.geometry.jts.CurvePolygon;
import org.geotools.geometry.jts.WKTWriter2;
import org.junit.Test;
import org.locationtech.jts.geom.Geometry;
import org.locationtech.jts.geom.Point;
import org.locationtech.jts.geom.Polygon;
import org.locationtech.jts.io.ParseException;

public class GeometryReaderTest {

    private GeometryReader reader = new GeometryReader();

    @Test
    public void testReadBadFormat() throws ParseException {
        assertThrows(ParseException.class, () -> {
            reader.read("NOT A WKT");
        });
    }

    @Test
    public void testEmptyPoint() throws ParseException {
        Geometry g = reader.read("POINT EMPTY");
        assertTrue(g instanceof Point);
        assertTrue(g.isEmpty());
    }

    @Test
    public void testEmptyPoint2D() throws ParseException {
        Geometry g = reader.read("POINT(3.0 4.0)");
        assertTrue(g instanceof Point);
        assertFalse(g.isEmpty());
        Geometry p = (Point) g;
        assertEquals("(3.0, 4.0, NaN)", p.getCoordinate().toString());
    }

    @Test
    public void testEmptyPoint3D() throws ParseException {
        Geometry g = reader.read("POINT(3.0 4.0 5.0)");
        assertTrue(g instanceof Point);
        assertFalse(g.isEmpty());
        Geometry p = (Point) g;
        assertEquals("(3.0, 4.0, 5.0)", p.getCoordinate().toString());
    }

    @Test
    public void testCurvePolygon() throws ParseException {
        String wkt = "CURVEPOLYGON (COMPOUNDCURVE ((1846417.13045624 5181584.75153719,1846417.14702617 5181584.75113042,1846417.16355619 5181584.74991109,1846417.18000647 5181584.74788215,1846417.19633737 5181584.74504847,1846417.21250956 5181584.74141688),CIRCULARSTRING (1846417.21250956 5181584.74141688,1846417.22848408 5181584.73699613,1846417.25968673 5181584.72583165),(1846417.25968673 5181584.72583165,1846417.27483969 5181584.7191148,1846417.28964482 5181584.71166253,1846417.30406645 5181584.70349278,1846417.31806983 5181584.69462523,1846417.33162124 5181584.68508125,1846417.34468803 5181584.67488383,1846417.35723871 5181584.66405754,1846417.36924305 5181584.65262846,1846417.38067214 5181584.64062412,1846417.39149843 5181584.62807343),CIRCULARSTRING (1846417.39149843 5181584.62807343,1846417.40169585 5181584.61500665,1846417.42010737 5181584.58745186),(1846417.42010737 5181584.58745186,1846417.42827713 5181584.57303023,1846417.4357294 5181584.5582251,1846417.44244625 5181584.54307214,1846417.44841148 5181584.52760785),CIRCULARSTRING (1846417.44841148 5181584.52760785,1846417.45803148 5181584.49589497,1846417.46449675 5181584.46339188),(1846417.46449675 5181584.46339188,1846417.46652569 5181584.4469416),CIRCULARSTRING (1846417.46652569 5181584.4469416,1846417.46774502 5181584.39727171,1846417.46166307 5181584.34796052),CIRCULARSTRING (1846417.46166307 5181584.34796052,1846417.45803148 5181584.33178832,1846417.44841148 5181584.30007545),(1846417.44841148 5181584.30007545,1846417.44244625 5181584.28461116,1846417.4357294 5181584.2694582,1846417.42827713 5181584.25465307,1846417.42010738 5181584.24023144,1846417.41123983 5181584.22622806,1846417.40169585 5181584.21267665,1846417.39149844 5181584.19960986,1846417.38067214 5181584.18705918),CIRCULARSTRING (1846417.38067214 5181584.18705918,1846417.35723872 5181584.16362575,1846417.33162125 5181584.14260204),(1846417.33162125 5181584.14260204,1846417.31806984 5181584.13305806,1846417.30406646 5181584.12419052,1846417.28964483 5181584.11602076,1846417.2748397 5181584.10856849,1846417.25968674 5181584.10185164,1846417.24422245 5181584.09588641,1846417.22848409 5181584.09068716),CIRCULARSTRING (1846417.22848409 5181584.09068716,1846417.19633738 5181584.08263483,1846417.1635562 5181584.0777722),(1846417.1635562 5181584.0777722,1846417.14702619 5181584.07655287,1846417.13045625 5181584.0761461,1846417.1138863 5181584.07655287,1846417.09735629 5181584.0777722,1846417.08090601 5181584.07980114,1846417.06457511 5181584.08263482,1846417.04840292 5181584.08626641),CIRCULARSTRING (1846417.04840292 5181584.08626641,1846417.0324284 5181584.09068715,1846417.00122575 5181584.10185164),(1846417.00122575 5181584.10185164,1846416.98607279 5181584.10856849,1846416.97126766 5181584.11602076,1846416.95684603 5181584.12419051),CIRCULARSTRING (1846416.95684603 5181584.12419051,1846416.92929124 5181584.14260204,1846416.90367377 5181584.16362575),(1846416.90367377 5181584.16362575,1846416.89166943 5181584.17505483,1846416.88024034 5181584.18705917,1846416.86941405 5181584.19960986,1846416.85921663 5181584.21267664,1846416.84967265 5181584.22622805,1846416.84080511 5181584.24023143),CIRCULARSTRING (1846416.84080511 5181584.24023143,1846416.83263535 5181584.25465306,1846416.81846623 5181584.28461115),(1846416.81846623 5181584.28461115,1846416.812501 5181584.30007544,1846416.80730175 5181584.3158138,1846416.802881 5181584.33178832,1846416.79924942 5181584.34796051,1846416.79641573 5181584.36429141,1846416.79438679 5181584.38074169),CIRCULARSTRING (1846416.79438679 5181584.38074169,1846416.79276069 5181584.41384164,1846416.79438679 5181584.44694159),(1846416.79438679 5181584.44694159,1846416.79641573 5181584.46339187),CIRCULARSTRING (1846416.79641573 5181584.46339187,1846416.802881 5181584.49589496,1846416.812501 5181584.52760784),CIRCULARSTRING (1846416.812501 5181584.52760784,1846416.82518308 5181584.55822509,1846416.8408051 5181584.58745185),(1846416.8408051 5181584.58745185,1846416.84967265 5181584.60145523,1846416.85921663 5181584.61500664,1846416.86941405 5181584.62807343,1846416.88024034 5181584.64062411,1846416.89166942 5181584.65262845,1846416.90367376 5181584.66405754,1846416.91622444 5181584.67488383,1846416.92929123 5181584.68508125,1846416.94284264 5181584.69462523,1846416.95684602 5181584.70349277,1846416.97126765 5181584.71166253,1846416.98607278 5181584.7191148,1846417.00122574 5181584.72583165,1846417.01669003 5181584.73179688,1846417.03242839 5181584.73699613),CIRCULARSTRING (1846417.03242839 5181584.73699613,1846417.0645751 5181584.74504846,1846417.09735628 5181584.74991109),(1846417.09735628 5181584.74991109,1846417.1138863 5181584.75113042,1846417.13045624 5181584.75153719)))";
        Geometry g = reader.read(wkt);
        assertTrue(g instanceof Polygon);
        assertTrue(g instanceof CurvePolygon);
        assertFalse(g.isEmpty());
        assertEquals(
            "POLYGON ((1846417.13045624 5181584.75153719, 1846417.14702617 5181584.75113042, 1846417.16355619 5181584.74991109, 1846417.18000647 5181584.74788215, 1846417.19633737 5181584.74504847, 1846417.21250956 5181584.74141688, 1846417.22848408 5181584.73699613, 1846417.25968673 5181584.72583165, 1846417.27483969 5181584.7191148, 1846417.28964482 5181584.71166253, 1846417.30406645 5181584.70349278, 1846417.31806983 5181584.69462523, 1846417.33162124 5181584.68508125, 1846417.34468803 5181584.67488383, 1846417.35723871 5181584.66405754, 1846417.36924305 5181584.65262846, 1846417.38067214 5181584.64062412, 1846417.39149843 5181584.62807343, 1846417.40169585 5181584.61500665, 1846417.4042161382 5181584.608770116, 1846417.4155635084 5181584.585759927, 1846417.42010737 5181584.58745186, 1846417.42827713 5181584.57303023, 1846417.4357294 5181584.5582251, 1846417.44244625 5181584.54307214, 1846417.44841148 5181584.52760785, 1846417.4484113147 5181584.527350023, 1846417.4501312447 5181584.501108961, 1846417.45803148 5181584.49589497, 1846417.4552616067 5181584.4753168905, 1846417.46449675 5181584.46339188, 1846417.46652569 5181584.4469416, 1846417.4649173846 5181584.437122759, 1846417.463564165 5181584.4164766185, 1846417.46774502 5181584.39727171, 1846417.4649173846 5181584.395830478, 1846417.4689538893 5181584.375537598, 1846417.4756046135 5181584.355945195, 1846417.46166307 5181584.34796052, 1846417.45803148 5181584.33178832, 1846417.44841148 5181584.30007545, 1846417.44244625 5181584.28461116, 1846417.4357294 5181584.2694582, 1846417.42827713 5181584.25465307, 1846417.42010738 5181584.24023144, 1846417.41123983 5181584.22622806, 1846417.40169585 5181584.21267665, 1846417.39149844 5181584.19960986, 1846417.38067214 5181584.18705918, 1846417.35723872 5181584.16362575, 1846417.33162125 5181584.14260204, 1846417.31806984 5181584.13305806, 1846417.30406646 5181584.12419052, 1846417.28964483 5181584.11602076, 1846417.2748397 5181584.10856849, 1846417.25968674 5181584.10185164, 1846417.24422245 5181584.09588641, 1846417.22848409 5181584.09068716, 1846417.2193968683 5181584.0908707315, 1846417.19633738 5181584.08263483, 1846417.1900269503 5181584.088945725, 1846417.1635562 5181584.0777722, 1846417.14702619 5181584.07655287, 1846417.13045625 5181584.0761461, 1846417.1138863 5181584.07655287, 1846417.09735629 5181584.0777722, 1846417.08090601 5181584.07980114, 1846417.06457511 5181584.08263482, 1846417.04840292 5181584.08626641, 1846417.0324284 5181584.09068715, 1846417.00122575 5181584.10185164, 1846416.98607279 5181584.10856849, 1846416.97126766 5181584.11602076, 1846416.95684603 5181584.12419051, 1846416.9533239573 5181584.127911462, 1846416.944145144 5181584.135961065, 1846416.9339941726 5181584.142743728, 1846416.92929124 5181584.14260204, 1846416.9230447293 5181584.148143396, 1846416.9114841619 5181584.15206768, 1846416.90367377 5181584.16362575, 1846416.89166943 5181584.17505483, 1846416.88024034 5181584.18705917, 1846416.86941405 5181584.19960986, 1846416.85921663 5181584.21267664, 1846416.84967265 5181584.22622805, 1846416.84080511 5181584.24023143, 1846416.83263535 5181584.25465306, 1846416.8210205473 5181584.276883903, 1846416.81846623 5181584.28461115, 1846416.812501 5181584.30007544, 1846416.80730175 5181584.3158138, 1846416.802881 5181584.33178832, 1846416.79924942 5181584.34796051, 1846416.79641573 5181584.36429141, 1846416.79438679 5181584.38074169, 1846416.79276069 5181584.41384164, 1846416.7930037165 5181584.427596222, 1846416.79438679 5181584.44694159, 1846416.79641573 5181584.46339187, 1846416.7977086825 5181584.480993187, 1846416.802881 5181584.49589496, 1846416.8016221703 5181584.500667619, 1846416.8080702063 5181584.51966292, 1846416.812501 5181584.52760784, 1846416.8131695706 5181584.528117116, 1846416.8248875944 5181584.538393547, 1846416.8351640257 5181584.55011157, 1846416.82518308 5181584.55822509, 1846416.8438230315 5181584.563070688, 1846416.850716454 5181584.577049167, 1846416.8408051 5181584.58745185, 1846416.84967265 5181584.60145523, 1846416.85921663 5181584.61500664, 1846416.86941405 5181584.62807343, 1846416.88024034 5181584.64062411, 1846416.89166942 5181584.65262845, 1846416.90367376 5181584.66405754, 1846416.91622444 5181584.67488383, 1846416.92929123 5181584.68508125, 1846416.94284264 5181584.69462523, 1846416.95684602 5181584.70349277, 1846416.97126765 5181584.71166253, 1846416.98607278 5181584.7191148, 1846417.00122574 5181584.72583165, 1846417.01669003 5181584.73179688, 1846417.03242839 5181584.73699613, 1846417.0645751 5181584.74504846, 1846417.0665704964 5181584.74335865, 1846417.09735628 5181584.74991109, 1846417.1138863 5181584.75113042, 1846417.13045624 5181584.75153719))",
            g.toText()
        );

        // ensure that internally, JTS stores a CurvePolygon
        WKTWriter2 writer = new WKTWriter2();
        assertEquals(
            "CURVEPOLYGON (COMPOUNDCURVE ((1846417.13045624 5181584.75153719, 1846417.14702617 5181584.75113042, 1846417.16355619 5181584.74991109, 1846417.18000647 5181584.74788215, 1846417.19633737 5181584.74504847, 1846417.21250956 5181584.74141688), CIRCULARSTRING (1846417.21250956 5181584.74141688, 1846417.22848408 5181584.73699613, 1846417.25968673 5181584.72583165), (1846417.25968673 5181584.72583165, 1846417.27483969 5181584.7191148, 1846417.28964482 5181584.71166253, 1846417.30406645 5181584.70349278, 1846417.31806983 5181584.69462523, 1846417.33162124 5181584.68508125, 1846417.34468803 5181584.67488383, 1846417.35723871 5181584.66405754, 1846417.36924305 5181584.65262846, 1846417.38067214 5181584.64062412, 1846417.39149843 5181584.62807343), CIRCULARSTRING (1846417.39149843 5181584.62807343, 1846417.40169585 5181584.61500665, 1846417.42010737 5181584.58745186), (1846417.42010737 5181584.58745186, 1846417.42827713 5181584.57303023, 1846417.4357294 5181584.5582251, 1846417.44244625 5181584.54307214, 1846417.44841148 5181584.52760785), CIRCULARSTRING (1846417.44841148 5181584.52760785, 1846417.45803148 5181584.49589497, 1846417.46449675 5181584.46339188), (1846417.46449675 5181584.46339188, 1846417.46652569 5181584.4469416), CIRCULARSTRING (1846417.46652569 5181584.4469416, 1846417.46774502 5181584.39727171, 1846417.46166307 5181584.34796052), CIRCULARSTRING (1846417.46166307 5181584.34796052, 1846417.45803148 5181584.33178832, 1846417.44841148 5181584.30007545), (1846417.44841148 5181584.30007545, 1846417.44244625 5181584.28461116, 1846417.4357294 5181584.2694582, 1846417.42827713 5181584.25465307, 1846417.42010738 5181584.24023144, 1846417.41123983 5181584.22622806, 1846417.40169585 5181584.21267665, 1846417.39149844 5181584.19960986, 1846417.38067214 5181584.18705918), CIRCULARSTRING (1846417.38067214 5181584.18705918, 1846417.35723872 5181584.16362575, 1846417.33162125 5181584.14260204), (1846417.33162125 5181584.14260204, 1846417.31806984 5181584.13305806, 1846417.30406646 5181584.12419052, 1846417.28964483 5181584.11602076, 1846417.2748397 5181584.10856849, 1846417.25968674 5181584.10185164, 1846417.24422245 5181584.09588641, 1846417.22848409 5181584.09068716), CIRCULARSTRING (1846417.22848409 5181584.09068716, 1846417.19633738 5181584.08263483, 1846417.1635562 5181584.0777722), (1846417.1635562 5181584.0777722, 1846417.14702619 5181584.07655287, 1846417.13045625 5181584.0761461, 1846417.1138863 5181584.07655287, 1846417.09735629 5181584.0777722, 1846417.08090601 5181584.07980114, 1846417.06457511 5181584.08263482, 1846417.04840292 5181584.08626641), CIRCULARSTRING (1846417.04840292 5181584.08626641, 1846417.0324284 5181584.09068715, 1846417.00122575 5181584.10185164), (1846417.00122575 5181584.10185164, 1846416.98607279 5181584.10856849, 1846416.97126766 5181584.11602076, 1846416.95684603 5181584.12419051), CIRCULARSTRING (1846416.95684603 5181584.12419051, 1846416.92929124 5181584.14260204, 1846416.90367377 5181584.16362575), (1846416.90367377 5181584.16362575, 1846416.89166943 5181584.17505483, 1846416.88024034 5181584.18705917, 1846416.86941405 5181584.19960986, 1846416.85921663 5181584.21267664, 1846416.84967265 5181584.22622805, 1846416.84080511 5181584.24023143), CIRCULARSTRING (1846416.84080511 5181584.24023143, 1846416.83263535 5181584.25465306, 1846416.81846623 5181584.28461115), (1846416.81846623 5181584.28461115, 1846416.812501 5181584.30007544, 1846416.80730175 5181584.3158138, 1846416.802881 5181584.33178832, 1846416.79924942 5181584.34796051, 1846416.79641573 5181584.36429141, 1846416.79438679 5181584.38074169), CIRCULARSTRING (1846416.79438679 5181584.38074169, 1846416.79276069 5181584.41384164, 1846416.79438679 5181584.44694159), (1846416.79438679 5181584.44694159, 1846416.79641573 5181584.46339187), CIRCULARSTRING (1846416.79641573 5181584.46339187, 1846416.802881 5181584.49589496, 1846416.812501 5181584.52760784), CIRCULARSTRING (1846416.812501 5181584.52760784, 1846416.82518308 5181584.55822509, 1846416.8408051 5181584.58745185), (1846416.8408051 5181584.58745185, 1846416.84967265 5181584.60145523, 1846416.85921663 5181584.61500664, 1846416.86941405 5181584.62807343, 1846416.88024034 5181584.64062411, 1846416.89166942 5181584.65262845, 1846416.90367376 5181584.66405754, 1846416.91622444 5181584.67488383, 1846416.92929123 5181584.68508125, 1846416.94284264 5181584.69462523, 1846416.95684602 5181584.70349277, 1846416.97126765 5181584.71166253, 1846416.98607278 5181584.7191148, 1846417.00122574 5181584.72583165, 1846417.01669003 5181584.73179688, 1846417.03242839 5181584.73699613), CIRCULARSTRING (1846417.03242839 5181584.73699613, 1846417.0645751 5181584.74504846, 1846417.09735628 5181584.74991109), (1846417.09735628 5181584.74991109, 1846417.1138863 5181584.75113042, 1846417.13045624 5181584.75153719)))",
            writer.write(g)
        );
    }

}
